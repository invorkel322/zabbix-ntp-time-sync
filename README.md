# NTP Timestamp Capture Script  

–°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å –≤–Ω–µ—à–Ω–∏–º NTP-—Å–µ—Ä–≤–µ—Ä–æ–º (`162.159.200.123`) —Å –ø–æ–º–æ—â—å—é `tcpdump`. –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ñ–∞–π–ª –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ Zabbix).  

---

## **üîç –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏**  
- –ó–∞—Ö–≤–∞—Ç NTP-–ø–∞–∫–µ—Ç–æ–≤ —Å —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.  
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ NTP-—Ñ–æ—Ä–º–∞—Ç–∞ (—Å 1900 –≥–æ–¥–∞) –≤ Unix-—Ñ–æ—Ä–º–∞—Ç (—Å 1970 –≥–æ–¥–∞).  
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ —Ä–∞–±–æ—Ç—ã.  
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (Zabbix, Prometheus).  

---

## **üõ†Ô∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?**  
1. **–ó–∞—Ö–≤–∞—Ç –ø–∞–∫–µ—Ç–∞**:  
   - –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç `tcpdump` –Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ `any` –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è UDP-–ø–æ—Ä—Ç–∞ `123` (NTP).  
   - –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–∞–∫–µ—Ç—ã –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ `162.159.200.123`.  
2. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏**:  
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ–ª–µ `Transmit Timestamp` –∏–∑ –∑–∞—Ö–≤–∞—á–µ–Ω–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–∞.  
   - –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –µ–≥–æ –≤ Unix-–≤—Ä–µ–º—è –ø–æ —Ñ–æ—Ä–º—É–ª–µ:  
     ```plaintext
     Unix Timestamp = NTP Timestamp - 2208988800 (—Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É 1900 –∏ 1970 –≥–æ–¥–æ–º –≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
     ```  
3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞**:  
   - –£—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ `$RESULT_FILE_OUT_NTP` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `/etc/zabbix/scripts/ntp.org_timestamp.txt`).  
   - –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è `0000000000`.  

---

## **üìÇ –§–∞–π–ª—ã –∏ –ª–æ–≥–∏**  
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: `/etc/zabbix/scripts/ntp.org_timestamp.txt` (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `RESULT_FILE_OUT_NTP`).  
- **–õ–æ–≥–∏**: `/var/log/ntp.org_timestamp.log` (–æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ).  
- **–í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**: `/tmp/output_OUT_NTP.txt` (—Å—ã—Ä–æ–π –≤—ã–≤–æ–¥ `tcpdump`).  

---

## **‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞**  
### **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**  
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:  
```bash
sudo apt install tcpdump ntpdate  # –î–ª—è Debian/Ubuntu
sudo yum install tcpdump ntpdate  # –î–ª—è CentOS/RHEL
1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
https://github.com/invorkel322/zabbix-ntp-time-sync.git
cd zabbix-ntp-time-sync
2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤
–î–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç—É –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:
chmod +x ntp_capture.sh
3. –ó–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é
sudo ./ntp_capture.sh
4. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è (cron/Zabbix)
–î–æ–±–∞–≤—å—Ç–µ –≤ cron –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç):
*/5 * * * * /path/to/ntp_capture.sh
–î–ª—è Zabbix:
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ UserParameter –≤ –∫–æ–Ω—Ñ–∏–≥–µ –∞–≥–µ–Ω—Ç–∞:
UserParameter=ntp.time, cat /etc/zabbix/scripts/ntp.org_timestamp.txt

üö® –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
–û—à–∏–±–∫–∞	–†–µ—à–µ–Ω–∏–µ
Failed to capture packets	–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ (ping 162.159.200.123) –∏ –ø—Ä–∞–≤–∏–ª–∞ —Ñ–∞–µ—Ä–≤–æ–ª–∞.
Permission denied	–ó–∞–ø—É—Å–∫–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å sudo –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É tcpdump.
Timestamp is empty	–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ tcpdump –≤–∏–¥–∏—Ç —Ç—Ä–∞—Ñ–∏–∫ –Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ (–ø–æ–ø—Ä–æ–±—É–π—Ç–µ —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤–º–µ—Å—Ç–æ any).

üìå –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å –ª–æ–∫–∞–ª—å–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º
LOCAL_TIME=$(date +%s)
NTP_TIME=$(cat /etc/zabbix/scripts/ntp.org_timestamp.txt)
DIFF=$((LOCAL_TIME - NTP_TIME))
echo "–†–∞–∑–Ω–∏—Ü–∞: $DIFF —Å–µ–∫—É–Ω–¥"
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Zabbix
–°–∫—Ä–∏–ø—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–µ—Ç–∫—É –≤ —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ —á–∏—Ç–∞—Ç—å —á–µ—Ä–µ–∑ Zabbix-–∞–≥–µ–Ω—Ç.

–°–æ–∑–¥–∞–π—Ç–µ —ç–ª–µ–º–µ–Ω—Ç –¥–∞–Ω–Ω—ã—Ö —Ç–∏–ø–∞ Zabbix trapper –∏–ª–∏ SSH.
