# NTP Timestamp Capture Script

–°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å –≤–Ω–µ—à–Ω–∏–º NTP-—Å–µ—Ä–≤–µ—Ä–æ–º (`162.159.200.123`) —Å –ø–æ–º–æ—â—å—é `tcpdump`. –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ñ–∞–π–ª –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ Zabbix).

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
- [–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏](#-–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)
- [–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç](#-–∫–∞–∫-—ç—Ç–æ-—Ä–∞–±–æ—Ç–∞–µ—Ç)
- [–§–∞–π–ª—ã –∏ –ª–æ–≥–∏](#-—Ñ–∞–π–ª—ã-–∏-–ª–æ–≥–∏)
- [–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞](#-—É—Å—Ç–∞–Ω–æ–≤–∫–∞-–∏-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
- [–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã](#-–≤–æ–∑–º–æ–∂–Ω—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã)
- [–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#-–ø—Ä–∏–º–µ—Ä-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
- [–õ–∏—Ü–µ–Ω–∑–∏—è](#-–ª–∏—Ü–µ–Ω–∑–∏—è)

## üîç –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- –ó–∞—Ö–≤–∞—Ç NTP-–ø–∞–∫–µ—Ç–æ–≤ —Å —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ NTP-—Ñ–æ—Ä–º–∞—Ç–∞ –≤ Unix-—Ñ–æ—Ä–º–∞—Ç
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ —Ä–∞–±–æ—Ç—ã
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (Zabbix, Prometheus)

## üõ†Ô∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?
1. **–ó–∞—Ö–≤–∞—Ç –ø–∞–∫–µ—Ç–∞**:
   - –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç `tcpdump` –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è UDP-–ø–æ—Ä—Ç–∞ 123 (NTP)
   - –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–∞–∫–µ—Ç—ã –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ `162.159.200.123`

2. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏**:
   ```plaintext
   Unix Timestamp = NTP Timestamp - 2208988800
   (—Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É 1900 –∏ 1970 –≥–æ–¥–æ–º –≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:

–£—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: /etc/zabbix/scripts/ntp.org_timestamp.txt

–ü—Ä–∏ –æ—à–∏–±–∫–µ: 0000000000

üìÇ –§–∞–π–ª—ã –∏ –ª–æ–≥–∏
–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ	–ü—É—Ç—å
–†–µ–∑—É–ª—å—Ç–∞—Ç	/etc/zabbix/scripts/ntp.org_timestamp.txt
–õ–æ–≥–∏	/var/log/ntp.org_timestamp.log
–í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ	/tmp/output_OUT_NTP.txt
‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
bash
# –î–ª—è Debian/Ubuntu:
sudo apt install tcpdump ntpdate

# –î–ª—è CentOS/RHEL:
sudo yum install tcpdump ntpdate
1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
bash
git clone https://github.com/yourname/ntp-timestamp-monitor.git
cd ntp-timestamp-monitor
2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤
bash
chmod +x ntp_capture.sh
3. –ó–∞–ø—É—Å–∫
bash
sudo ./ntp_capture.sh
4. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è (cron)
bash
# –î–æ–±–∞–≤—å—Ç–µ –≤ cron –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç:
*/5 * * * * /path/to/ntp_capture.sh
üö® –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
–û—à–∏–±–∫–∞	–†–µ—à–µ–Ω–∏–µ
Failed to capture packets	–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ –∏ –ø—Ä–∞–≤–∏–ª–∞ —Ñ–∞–µ—Ä–≤–æ–ª–∞
Permission denied	–ó–∞–ø—É—Å–∫–∞–π—Ç–µ —Å sudo –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É tcpdump
Timestamp is empty	–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ tcpdump –≤–∏–¥–∏—Ç —Ç—Ä–∞—Ñ–∏–∫ –Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
üìå –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
bash
LOCAL_TIME=$(date +%s)
NTP_TIME=$(cat /etc/zabbix/scripts/ntp.org_timestamp.txt)
DIFF=$((LOCAL_TIME - NTP_TIME))
echo "–†–∞–∑–Ω–∏—Ü–∞: $DIFF —Å–µ–∫—É–Ω–¥"
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Zabbix
–î–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ–Ω—Ñ–∏–≥ –∞–≥–µ–Ω—Ç–∞:

ini
UserParameter=ntp.time, cat /etc/zabbix/scripts/ntp.org_timestamp.txt
–°–æ–∑–¥–∞–π—Ç–µ —ç–ª–µ–º–µ–Ω—Ç –¥–∞–Ω–Ω—ã—Ö —Ç–∏–ø–∞ Zabbix trapper
